using System.Collections.Generic;
using Microsoft.AspNetCore.Mvc;
using Moq;
using EMMABusiness;
using EMMAModel;
using EMMA_Project.Controllers;
using Xunit;

namespace EMMAIntegratedTests
{
    public class ReadingControllerUnitModelTests
    {
        [Fact]
        public void Get_WhenNoReadings_ReturnsNoContent()
        {
            var mockService = new Mock<IReadingService>();
            mockService.Setup(s => s.ListarTodos()).Returns(new List<Reading>());

            var controller = new ReadingController(mockService.Object);

            var result = controller.GetAll();

            Assert.IsType<NoContentResult>(result);
        }

        [Fact]
        public void GetById_WhenNotFound_ReturnsNotFound()
        {
            var mockService = new Mock<IReadingService>();
            mockService.Setup(s => s.ObterPorId(It.IsAny<int>())).Returns((Reading?)null);

            var controller = new ReadingController(mockService.Object);

            var result = controller.GetById(123);

            // controller returns NotFound(new { ... }) so the result is NotFoundObjectResult
            Assert.IsType<NotFoundObjectResult>(result);
        }

        [Fact]
        public async System.Threading.Tasks.Task Post_WhenValid_ReturnsCreatedAtAction()
        {
            var input = new Reading { Description = "teste", Humor = "happy" };
            var created = new Reading { IdReading = 42, Description = input.Description, Humor = input.Humor };

            var mockService = new Mock<IReadingService>();
            mockService.Setup(s => s.Criar(It.IsAny<Reading>())).Returns(created);

            var controller = new ReadingController(mockService.Object);

            var actionResult = await controller.Create(input) as CreatedAtActionResult;

            Assert.NotNull(actionResult);
            Assert.Equal(nameof(ReadingController.GetById), actionResult.ActionName);
            var value = actionResult.Value as Reading;
            Assert.NotNull(value);
            Assert.Equal(42, value.IdReading);
        }
    }
}
