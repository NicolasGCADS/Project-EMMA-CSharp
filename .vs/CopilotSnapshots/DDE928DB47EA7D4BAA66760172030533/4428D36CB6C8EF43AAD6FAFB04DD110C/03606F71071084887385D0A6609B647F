using System.Net;
using System.Net.Http.Json;
using Xunit;
using Microsoft.AspNetCore.Mvc.Testing;
using EMMAData;
using EMMAModel;

namespace EMMAIntegratedTests
{
    public class PersonCrudTests : IClassFixture<CustomWebApplicationFactory>
    {
        private readonly HttpClient _client;

        public PersonCrudTests(CustomWebApplicationFactory factory)
        {
            _client = factory.CreateClient();
        }

        [Fact]
        public async Task Create_Get_Update_Delete_Person_Workflow()
        {
            var person = new Person { Name = "PTest", Email = "ptest@example.com", Password = "pwd" };

            // Create
            var createResp = await _client.PostAsJsonAsync("/api/v1/Person", person);
            Assert.Equal(HttpStatusCode.Created, createResp.StatusCode);
            var created = await createResp.Content.ReadFromJsonAsync<Person>();
            Assert.NotNull(created);

            // Get
            var getResp = await _client.GetAsync($"/api/v1/Person/{created.IdPerson}");
            Assert.Equal(HttpStatusCode.OK, getResp.StatusCode);

            // Update
            created.Name = "PTest Updated";
            var putResp = await _client.PutAsJsonAsync($"/api/v1/Person/{created.IdPerson}", created);
            Assert.Equal(HttpStatusCode.NoContent, putResp.StatusCode);

            // Delete
            var delResp = await _client.DeleteAsync($"/api/v1/Person/{created.IdPerson}");
            Assert.Equal(HttpStatusCode.NoContent, delResp.StatusCode);
        }
    }
}
